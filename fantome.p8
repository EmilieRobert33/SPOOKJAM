pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
function _init()
 init_s()
	p={}
	p.x=64
	p.y=64
	
	mask=0
	fants={}
	timer_f=40
	fants_f=8
	f_f=0
--	make_f(10,10)
--	make_f(100,10)
--	make_f(100,100)
--	make_f(10,100)
--	make_f(64,0)
--	make_f(64,128)
	
	init_bug()
end

function _update60()
 detect_fait_fantome()
	if (btn(⬅️)) p.x-=1
	if (btn(➡️)) p.x+=1
	if (btn(⬆️)) p.y-=1
	if (btn(⬇️)) p.y+=1
	if (btnp(❎)) then
		if (mask==1) then
			mask=0
		else
			mask=1
		end
	end
	up_f()
	if bug_p>0 then
		temps=20*bug_p
		a=800*bug_p
		bug_p=0
	end
end

function _draw()
	cls()
	map(0,0,0,0,64,64)
	circfill(p.x,p.y,8,9)
	draw_f()
	bug(a,temps)
end


function make_f(x,y)
	local f={}
	f.x=x
	f.y=y
	add(fants,f)
end

function draw_f()
	print (temps)
	if (mask==1) then
		for i=1,#fants do
   if (fants[i].x<p.x) then
			 spr(fants_f,fants[i].x,fants[i].y,2,2,1)
   else
    spr(fants_f,fants[i].x,fants[i].y,2,2)
   end
		end
	else
		for i=1,#fants do
			circfill(fants[i].x,fants[i].y,3,8)
		end
	end
 draw_s()
end

function up_f()
-----------------------------------------------------
--animation des fantomes
-----------------------------------------------------
f_f+=1
if (f_f>20) then
	f_f=0
	fants_f+=2
end

if (fants_f>14) fants_f=8
-----------------------------------------------------
-- on bouge les fantomes
-----------------------------------------------------
 if mask==0 then --sans port du masque on s'approche
 	timer_f=40
		for i=1,#fants do
			if (p.x>=fants[i].x) fants[i].x+=0.15
			if (p.x<=fants[i].x) fants[i].x-=0.15
			if (p.y<=fants[i].y) fants[i].y-=0.15
			if (p.y>=fants[i].y) fants[i].y+=0.15
		end
	elseif mask==1 then
		if timer_f<0 then --avec port du mask on go
			for i=1,#fants do
				if (p.x>=fants[i].x) fants[i].x-=0.15
				if (p.x<=fants[i].x) fants[i].x+=0.15
				if (p.y<=fants[i].y) fants[i].y-=0.15
				if (p.y>=fants[i].y) fants[i].y+=0.15
			end
			else 
				timer_f-=1
				for i=1,#fants do
     make_s(fants[i].x+8,fants[i].y+8,1-rnd(2),color)
					fants[i].x+=0.005*cos(3*t())
					fants[i].y+=-0.005*sin(3*t())				
				end
			end
   update_s()		
	end
-------------------------------------------------------
-- on declenche le bug
-------------------------------------------------------
	--if (temps<=0) sfx(0)
	for i=1,#fants do
		if (mask!=1 and bug_p==0 and temps<=-20)then
		sfx(0,1)
			if (abs(p.x-fants[i].x)< 90 and temps<=0) bug_p+=1
			if (abs(p.x-fants[i].x)< 50 and temps<=0) bug_p+=1
			if (abs(p.x-fants[i].x)< 30 and temps<=0) bug_p+=1
		end
	end	
end

function bug(t,int)
	temps-=1
	if t>0 then
		--sfx(0,1)
		--camera(16-rnd(18),16-rnd(18))
		for i=0,int do
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		poke4(0x6000+rnd(32732-24576),rnd(0xffff))
		--poke(0x6011,rnd(15))
		--poke(0x6100,rnd(15))
		end
	end
end

function init_bug()
	bug_p=0
	temps=0
	a=0
	bug_f=0
end

function make_s(x,y,init_t)
 local s = {}
 s.x=x
 s.y=y
 s.width = init_t
 s.width_final = init_t + rnd(3)+1
 s.t=0
 s.max_t = 15+rnd(10)
 s.dx = 1-rnd(2)
 s.dy = 1-rnd(2)
 s.ddy = .02
 add(smoke,s)
 return s
end

function init_s()
 smoke = {}
 cursorx = 50
 cursory = 50
 color = 7
end

function draw_s()
  for i=1,#smoke do
    if (smoke[i]!=nil) circfill(smoke[i].x, smoke[i].y,smoke[i].width, rnd({7,12}))
  end
 --foreach(smoke, draw_s) gg
end
function move_s(sp)
 if (sp.t > sp.max_t) then
 del(smoke,sp)
 end
 if (sp.t < sp.max_t) then
 sp.width +=1
 sp.width = min(sp.width,sp.width_final)
 end
 sp.x = sp.x + sp.dx
 sp.y = sp.y + sp.dy
 sp.dy= sp.dy+ sp.ddy
 sp.t = sp.t + 1
end

function update_s ()
 for i=1,#smoke do
  if (smoke[i]!=nil) move_s(smoke[i])
 end
end

function detect_fait_fantome()
 if btn(🅾️) then
  for x=0,64 do
   for y=0,64 do 
   if (fget(mget(x,y),7)) then
    mset(x,y,1)
    make_f(x*8,y*8)
   end
  end
 end
 end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000777000000000000077700000000000007770000000000000777000000
00000000000000000000000000000000000000000000000000000000000000000000007777700000000000777770000000000077777000000000007777700000
00700700000000000000000000000000000000000000000000000000000000000000077878770000000007787877000000000778787700000770077878770000
000770000000000000000000000000000000000000000000000000000000000007700777777c000000000777777c007000000777777c000077770777777c0000
000770000000000000000000000000000000000000000000000000000000000077770777877c007000000777877c077707700777877c000077770777877c0000
00700700000000000000000000000000000000000000000000000000000000007777007878c007770000007878c007777777007878c000700770007878c00000
00000000000000000000000000000000000000000000000000000000000000000770000787000777077000078700007077770007870007770000000787000000
00000000000000000000000000000000000000000000000000000000000000000000007777700070777700000000000007700000000007770000000000000070
000000000000000000000000000000000000000000000000000000000000000000000777777c0000777700777770000000000077777000700000007777700777
000000000000000000000000000000000000000000000000000000000000000000000777777c000007700777777c000000000777777c000000000777777c0777
000000000000000000000000000000000000000000000000000000000000000000000777777c000000000777777c000000000777777c000000000777777c0070
00000000000000000000000000000000000000000000000000000000000000000007707777c0000000000777777c000000000777777c000000000777777c0000
000000000000000000000000000000000000000000000000000000000000000000777707cc0000000007707777c000000007707777c000000007707777c00000
000000000000000000000000000000000000000000000000000000000000000000777c000000000000777007cc00000000777007cc00000000777007cc000000
0000000000000000000000000000000000000000000000000000000000000000770cc0000000000077777c000000000077777c000000000077777c0000000000
00000000000000000000000000000000000000000000000000000000000000000c000000000000000c0cc000000000000c0cc000000000000c0cc00000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088888888
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000002f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000002f2f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00002f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000600003365032650316503165031650326503365000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
